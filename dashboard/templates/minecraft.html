{% extends "base.html" %}

{% block title %}Minecraft{% endblock %}
{% block page_title %}Minecraft Server{% endblock %}

{% block content %}
<div class="space-y-6" x-data="minecraftPage()">

    <!-- Status Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stat-card">
            <div class="flex items-center justify-between mb-3">
                <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide">Status</p>
                <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                     :class="status && status.online ? 'bg-[#23a559]/10' : 'bg-[#f23f43]/10'">
                    <div class="w-3 h-3 rounded-full" :class="status && status.online ? 'status-dot-online' : 'status-dot-offline'"></div>
                </div>
            </div>
            <p class="text-2xl font-bold text-white" x-text="status ? (status.online ? 'Online' : 'Offline') : '-'"></p>
        </div>
        <div class="stat-card">
            <div class="flex items-center justify-between mb-3">
                <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide">Players</p>
                <div class="w-8 h-8 rounded-lg bg-[#5865f2]/10 flex items-center justify-center">
                    <svg class="w-4 h-4 text-[#5865f2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                </div>
            </div>
            <p class="text-2xl font-bold text-white" x-text="status ? `${status.players_online || 0}/${status.players_max || 0}` : '-'"></p>
        </div>
        <div class="stat-card">
            <div class="flex items-center justify-between mb-3">
                <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide">Version</p>
                <div class="w-8 h-8 rounded-lg bg-[#f0b232]/10 flex items-center justify-center">
                    <svg class="w-4 h-4 text-[#f0b232]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                </div>
            </div>
            <p class="text-2xl font-bold text-white" x-text="status && status.version ? status.version : '-'"></p>
        </div>
        <div class="stat-card">
            <div class="flex items-center justify-between mb-3">
                <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide">TPS</p>
                <div class="w-8 h-8 rounded-lg bg-[#eb459e]/10 flex items-center justify-center">
                    <svg class="w-4 h-4 text-[#eb459e]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
            </div>
            <p class="text-2xl font-bold text-white" x-text="status && status.tps != null ? status.tps : '-'"></p>
        </div>
    </div>

    <!-- Error state -->
    <div x-show="statusError" x-cloak class="card p-5 border border-[#f23f43]/20">
        <div class="flex items-center gap-3">
            <svg class="w-5 h-5 text-[#f23f43] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
            <p class="text-sm text-[#f87171]" x-text="statusError"></p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- RCON Console -->
        <div class="card p-6">
            <h3 class="text-sm font-semibold text-white mb-4">RCON Console</h3>
            <div class="terminal p-4 h-72 overflow-y-auto scrollbar-thin mb-4" x-ref="consoleOutput">
                <template x-if="commandHistory.length === 0">
                    <p class="text-[#64748b]">Type a command below to get started...</p>
                </template>
                <template x-for="(entry, i) in commandHistory" :key="i">
                    <div class="mb-2">
                        <div class="flex items-center gap-1.5">
                            <span class="text-[#5865f2]">&gt;</span>
                            <span class="text-[#e2e8f0]" x-text="entry.command"></span>
                        </div>
                        <div x-show="entry.loading" class="text-[#64748b] ml-4 mt-0.5">Executing...</div>
                        <div x-show="entry.response !== null && !entry.loading" class="text-[#4ade80] ml-4 mt-0.5 whitespace-pre-wrap" x-text="entry.response"></div>
                        <div x-show="entry.error" class="text-[#f87171] ml-4 mt-0.5" x-text="entry.error"></div>
                    </div>
                </template>
            </div>
            <form @submit.prevent="executeCommand()" class="flex gap-2">
                <input x-model="command" type="text" placeholder="Enter RCON command..."
                       class="input-field font-mono text-sm flex-1" :disabled="commandLoading">
                <button type="submit" :disabled="commandLoading || !command.trim()" class="btn btn-primary text-sm px-4">
                    <svg x-show="commandLoading" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    <span x-show="!commandLoading">Run</span>
                </button>
            </form>
        </div>

        <!-- Whitelist & Players -->
        <div class="space-y-6">
            <!-- Whitelist -->
            <div class="card p-6">
                <h3 class="text-sm font-semibold text-white mb-4">Whitelist Management</h3>
                <div class="flex gap-2 mb-4">
                    <input x-model="whitelistPlayer" type="text" placeholder="Player name"
                           class="input-field text-sm flex-1">
                    <button @click="whitelistAction('add')" :disabled="whitelistLoading || !whitelistPlayer.trim()"
                            class="btn text-sm px-3 py-2 bg-[#23a559]/15 text-[#4ade80] hover:bg-[#23a559]/25">Add</button>
                    <button @click="whitelistAction('remove')" :disabled="whitelistLoading || !whitelistPlayer.trim()"
                            class="btn text-sm px-3 py-2 bg-[#f23f43]/15 text-[#f87171] hover:bg-[#f23f43]/25">Remove</button>
                </div>
            </div>

            <!-- Online Players -->
            <div class="card p-6">
                <h3 class="text-sm font-semibold text-white mb-4">Online Players</h3>
                <template x-if="status && status.player_list && status.player_list.length > 0">
                    <div class="flex flex-wrap gap-2">
                        <template x-for="player in status.player_list" :key="player">
                            <span class="px-3 py-1.5 rounded-lg bg-[#23a559]/10 text-[#4ade80] text-xs font-medium" x-text="player"></span>
                        </template>
                    </div>
                </template>
                <template x-if="!status || !status.player_list || status.player_list.length === 0">
                    <div class="empty-state py-8">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <p class="text-sm">No players online</p>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function minecraftPage() {
    return {
        status: null,
        statusLoading: true,
        statusError: null,
        command: '',
        commandHistory: [],
        commandLoading: false,
        whitelistPlayer: '',
        whitelistLoading: false,

        async init() {
            await this.fetchStatus();
            setInterval(() => this.fetchStatus(), 30000);
        },

        async fetchStatus() {
            try {
                const res = await Auth.fetch('/api/v1/minecraft/status');
                if (res.ok) {
                    this.status = await res.json();
                    this.statusError = null;
                } else if (res.status === 503 || res.status === 400) {
                    const data = await res.json().catch(() => ({}));
                    this.statusError = data.detail || 'Minecraft RCON is not enabled or server is offline';
                } else {
                    this.statusError = 'Failed to fetch server status';
                }
            } catch (e) {
                this.statusError = 'Failed to connect to API';
            } finally {
                this.statusLoading = false;
            }
        },

        async executeCommand() {
            if (!this.command.trim()) return;
            this.commandLoading = true;
            const cmd = this.command.trim();
            const entry = { command: cmd, response: null, error: null, loading: true };
            this.commandHistory.push(entry);
            this.command = '';

            this.$nextTick(() => {
                if (this.$refs.consoleOutput) {
                    this.$refs.consoleOutput.scrollTop = this.$refs.consoleOutput.scrollHeight;
                }
            });

            try {
                const res = await Auth.fetch('/api/v1/minecraft/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: cmd }),
                });
                const data = await res.json();
                if (res.ok) {
                    entry.response = data.response || 'Command executed';
                } else {
                    entry.error = data.detail || 'Command failed';
                }
            } catch (e) {
                entry.error = 'Failed to execute command';
            } finally {
                entry.loading = false;
                this.commandLoading = false;
                this.$nextTick(() => {
                    if (this.$refs.consoleOutput) {
                        this.$refs.consoleOutput.scrollTop = this.$refs.consoleOutput.scrollHeight;
                    }
                });
            }
        },

        async whitelistAction(action) {
            if (!this.whitelistPlayer.trim()) return;
            this.whitelistLoading = true;
            try {
                const res = await Auth.fetch(`/api/v1/minecraft/whitelist/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player: this.whitelistPlayer.trim() }),
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(`Player ${this.whitelistPlayer} ${action === 'add' ? 'added to' : 'removed from'} whitelist`, 'success');
                    this.whitelistPlayer = '';
                    await this.fetchStatus();
                } else {
                    showToast(data.detail || `Failed to ${action} player`, 'error');
                }
            } catch (e) {
                showToast('Whitelist action failed', 'error');
            } finally {
                this.whitelistLoading = false;
            }
        }
    };
}
</script>
{% endblock %}

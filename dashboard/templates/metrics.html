{% extends "base.html" %}

{% block title %}Metrics{% endblock %}
{% block page_title %}Metrics{% endblock %}

{% block content %}
<div class="space-y-6" x-data="metricsPage()">

    <!-- Controls -->
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <label class="flex items-center gap-2 cursor-pointer">
                <button type="button" @click="toggleAutoRefresh()"
                        class="toggle" :class="autoRefresh ? 'bg-[#5865f2]' : 'bg-white/10'">
                    <span class="toggle-dot ml-0.5" :class="autoRefresh ? 'translate-x-5' : 'translate-x-0'"></span>
                </button>
                <span class="text-xs font-medium text-[#94a3b8]">Auto-refresh (30s)</span>
            </label>
        </div>
        <div class="flex items-center gap-3">
            <span x-show="lastUpdated" class="text-xs text-[#64748b]" x-text="'Updated ' + lastUpdated"></span>
            <button @click="fetchMetrics()" :disabled="loading" class="btn btn-ghost text-xs py-1.5 px-3">
                <svg class="w-3.5 h-3.5" :class="loading && 'animate-spin'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Refresh
            </button>
        </div>
    </div>

    <!-- System Metrics -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- CPU -->
        <div class="card p-5">
            <div class="flex items-center justify-between mb-3">
                <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide">CPU</p>
                <span class="text-lg font-bold text-white" x-text="`${metrics.cpu.toFixed(1)}%`"></span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" :style="`width: ${metrics.cpu}%; background: ${getBarColor(metrics.cpu)}`"></div>
            </div>
        </div>
        <!-- Memory -->
        <div class="card p-5">
            <div class="flex items-center justify-between mb-3">
                <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide">Memory</p>
                <span class="text-lg font-bold text-white" x-text="`${metrics.memory.toFixed(1)}%`"></span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" :style="`width: ${metrics.memory}%; background: ${getBarColor(metrics.memory)}`"></div>
            </div>
            <p class="text-[11px] text-[#64748b] mt-2" x-text="`${metrics.memoryMb.toFixed(0)} MB used`"></p>
        </div>
        <!-- Disk -->
        <div class="card p-5">
            <div class="flex items-center justify-between mb-3">
                <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide">Disk</p>
                <span class="text-lg font-bold text-white" x-text="`${metrics.disk.toFixed(1)}%`"></span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" :style="`width: ${metrics.disk}%; background: ${getBarColor(metrics.disk)}`"></div>
            </div>
        </div>
        <!-- Python -->
        <div class="card p-5">
            <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide mb-3">Python</p>
            <p class="text-lg font-bold text-white" x-text="metrics.python || '-'"></p>
            <p class="text-[11px] text-[#64748b] mt-1 truncate" x-text="metrics.platform || ''"></p>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stat-card">
            <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide mb-3">Total Users</p>
            <p class="text-2xl font-bold text-white" x-text="formatNumber(metrics.totalUsers)"></p>
        </div>
        <div class="stat-card">
            <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide mb-3">Active (24h)</p>
            <p class="text-2xl font-bold text-white" x-text="formatNumber(metrics.activeUsers)"></p>
        </div>
        <div class="stat-card">
            <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide mb-3">Total Guilds</p>
            <p class="text-2xl font-bold text-white" x-text="formatNumber(metrics.totalGuilds)"></p>
        </div>
        <div class="stat-card">
            <p class="text-xs font-semibold text-[#94a3b8] uppercase tracking-wide mb-3">Events (24h)</p>
            <p class="text-2xl font-bold text-white" x-text="formatNumber(metrics.events)"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function metricsPage() {
    return {
        metrics: {
            cpu: 0, memory: 0, memoryMb: 0, disk: 0,
            python: null, platform: null,
            totalUsers: 0, activeUsers: 0, totalGuilds: 0, events: 0,
        },
        autoRefresh: true,
        refreshInterval: null,
        lastUpdated: null,
        loading: false,

        async init() {
            await this.fetchMetrics();
            this.startAutoRefresh();
        },

        async fetchMetrics() {
            this.loading = true;
            try {
                const res = await Auth.fetch('/api/v1/dashboard/metrics');
                if (res.ok) {
                    const data = await res.json();
                    this.metrics = {
                        cpu: data.system?.cpu_percent || 0,
                        memory: data.system?.memory_percent || 0,
                        memoryMb: data.system?.memory_used_mb || 0,
                        disk: data.system?.disk_percent || 0,
                        python: data.system?.python_version || null,
                        platform: data.system?.platform || null,
                        totalUsers: data.users?.total || 0,
                        activeUsers: data.users?.active_24h || 0,
                        totalGuilds: data.guilds?.total || 0,
                        events: data.audit?.events_24h || 0,
                    };
                    this.lastUpdated = new Date().toLocaleTimeString();
                }
            } catch (e) {
                showToast('Failed to fetch metrics', 'error');
            } finally {
                this.loading = false;
            }
        },

        toggleAutoRefresh() {
            this.autoRefresh = !this.autoRefresh;
            if (this.autoRefresh) {
                this.startAutoRefresh();
            } else {
                this.stopAutoRefresh();
            }
        },

        startAutoRefresh() {
            this.stopAutoRefresh();
            if (this.autoRefresh) {
                this.refreshInterval = setInterval(() => this.fetchMetrics(), 30000);
            }
        },

        stopAutoRefresh() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
                this.refreshInterval = null;
            }
        },

        destroy() {
            this.stopAutoRefresh();
        }
    };
}
</script>
{% endblock %}

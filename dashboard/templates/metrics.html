{% extends "base.html" %}

{% block title %}Metrics{% endblock %}
{% block page_title %}Server Metrics{% endblock %}

{% block content %}
<div class="space-y-6" x-data="metricsPage()">
    <!-- Refresh Controls -->
    <div class="flex items-center justify-between">
        <p class="text-sm text-gray-400">Last updated: <span class="font-medium" x-text="lastUpdated"></span></p>
        <div class="flex items-center gap-3">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" x-model="autoRefresh" class="rounded border-gray-300 dark:border-gray-600 text-discord-blurple focus:ring-discord-blurple bg-white dark:bg-discord-dark">
                <span class="text-sm text-gray-500 dark:text-gray-400">Auto-refresh (30s)</span>
            </label>
            <button @click="fetchMetrics()" class="btn-secondary text-sm py-1.5">Refresh</button>
        </div>
    </div>

    <!-- System Metrics -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card">
            <h3 class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">CPU Usage</h3>
            <span class="text-2xl font-bold" x-text="`${metrics.cpu}%`"></span>
            <div class="mt-3 w-full bg-gray-100 dark:bg-discord-dark rounded-full h-2">
                <div class="h-2 rounded-full transition-all duration-500" :style="`width: ${metrics.cpu}%; background-color: ${getColor(metrics.cpu)}`"></div>
            </div>
        </div>

        <div class="card">
            <h3 class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Memory Usage</h3>
            <div class="flex items-baseline gap-2">
                <span class="text-2xl font-bold" x-text="`${metrics.memory}%`"></span>
                <span class="text-sm text-gray-400" x-text="`${metrics.memoryMb} MB`"></span>
            </div>
            <div class="mt-3 w-full bg-gray-100 dark:bg-discord-dark rounded-full h-2">
                <div class="h-2 rounded-full transition-all duration-500" :style="`width: ${metrics.memory}%; background-color: ${getColor(metrics.memory)}`"></div>
            </div>
        </div>

        <div class="card">
            <h3 class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Disk Usage</h3>
            <span class="text-2xl font-bold" x-text="`${metrics.disk}%`"></span>
            <div class="mt-3 w-full bg-gray-100 dark:bg-discord-dark rounded-full h-2">
                <div class="h-2 rounded-full transition-all duration-500" :style="`width: ${metrics.disk}%; background-color: ${getColor(metrics.disk)}`"></div>
            </div>
        </div>

        <div class="card">
            <h3 class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Python Version</h3>
            <span class="text-2xl font-bold" x-text="metrics.python"></span>
            <p class="text-xs text-gray-400 mt-2" x-text="metrics.platform"></p>
        </div>
    </div>

    <!-- Application Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card">
            <h3 class="text-base font-semibold mb-4">User Statistics</h3>
            <div class="space-y-2">
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-discord-dark rounded-lg">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Total Users</span>
                    <span class="text-sm font-semibold" x-text="metrics.users.total"></span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-discord-dark rounded-lg">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Active (24h)</span>
                    <span class="text-sm font-semibold" x-text="metrics.users.active"></span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-discord-dark rounded-lg">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Total Guilds</span>
                    <span class="text-sm font-semibold" x-text="metrics.guilds"></span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 class="text-base font-semibold mb-4">Activity Statistics</h3>
            <div class="space-y-2">
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-discord-dark rounded-lg">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Events (24h)</span>
                    <span class="text-sm font-semibold" x-text="metrics.events"></span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-discord-dark rounded-lg">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Audit Logs (24h)</span>
                    <span class="text-sm font-semibold" x-text="metrics.auditLogs"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function metricsPage() {
    return {
        metrics: {
            cpu: 0,
            memory: 0,
            memoryMb: 0,
            disk: 0,
            python: '-',
            platform: '-',
            users: { total: 0, active: 0 },
            guilds: 0,
            events: 0,
            auditLogs: 0,
        },
        lastUpdated: 'Never',
        autoRefresh: true,
        refreshInterval: null,

        async init() {
            await this.fetchMetrics();
            this.startAutoRefresh();
        },

        getColor(percent) {
            if (percent >= 80) return '#ed4245';
            if (percent >= 60) return '#faa61a';
            return '#3ba55c';
        },

        async fetchMetrics() {
            try {
                const response = await Auth.fetch('/api/v1/dashboard/metrics');
                if (response.ok) {
                    const data = await response.json();
                    this.metrics = {
                        cpu: data.system.cpu_percent.toFixed(1),
                        memory: data.system.memory_percent.toFixed(1),
                        memoryMb: data.system.memory_used_mb.toFixed(0),
                        disk: data.system.disk_percent.toFixed(1),
                        python: data.system.python_version,
                        platform: data.system.platform,
                        users: {
                            total: data.users.total,
                            active: data.users.active_24h,
                        },
                        guilds: data.guilds.total,
                        events: data.audit.events_24h,
                        auditLogs: data.audit.events_24h,
                    };
                    this.lastUpdated = new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Failed to fetch metrics:', error);
            }
        },

        startAutoRefresh() {
            this.$watch('autoRefresh', (value) => {
                if (value) {
                    this.refreshInterval = setInterval(() => this.fetchMetrics(), 30000);
                } else if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
            });

            if (this.autoRefresh) {
                this.refreshInterval = setInterval(() => this.fetchMetrics(), 30000);
            }
        }
    };
}
</script>
{% endblock %}

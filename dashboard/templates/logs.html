{% extends "base.html" %}

{% block title %}Live Logs{% endblock %}
{% block page_title %}Live Logs{% endblock %}

{% block content %}
<div class="space-y-4" x-data="logsPage()">

    <!-- Controls -->
    <div class="card p-4">
        <div class="flex flex-wrap items-center gap-3">
            <!-- Level Filter -->
            <div class="flex items-center gap-2">
                <label class="text-xs font-medium text-[#94a3b8]">Level</label>
                <select x-model="minLevel" class="input-field text-sm py-1.5 px-3 w-32">
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                    <option value="CRITICAL">CRITICAL</option>
                </select>
            </div>

            <!-- Auto-scroll -->
            <label class="flex items-center gap-2 cursor-pointer">
                <button type="button" @click="autoScroll = !autoScroll"
                        class="toggle" :class="autoScroll ? 'bg-[#5865f2]' : 'bg-white/10'">
                    <span class="toggle-dot ml-0.5" :class="autoScroll ? 'translate-x-5' : 'translate-x-0'"></span>
                </button>
                <span class="text-xs font-medium text-[#94a3b8]">Auto-scroll</span>
            </label>

            <div class="flex-1"></div>

            <!-- Connection Status -->
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full" :class="connected ? 'status-dot-online' : 'status-dot-offline'"></div>
                <span class="text-xs font-medium" :class="connected ? 'text-[#23a559]' : 'text-[#f23f43]'"
                      x-text="connected ? 'Connected' : 'Disconnected'"></span>
            </div>

            <!-- Entry count -->
            <span class="badge badge-blurple" x-text="`${filteredLogs.length} entries`"></span>

            <!-- Buttons -->
            <button @click="clearLogs()" class="btn btn-ghost text-xs py-1.5 px-3">Clear</button>
            <button x-show="!connected" @click="reconnect()" class="btn btn-primary text-xs py-1.5 px-3">Reconnect</button>
        </div>
    </div>

    <!-- Log Output -->
    <div class="card overflow-hidden">
        <div class="log-container p-4 h-[calc(100vh-280px)] overflow-y-auto scrollbar-thin" x-ref="logContainer">
            <template x-if="filteredLogs.length === 0">
                <div class="flex items-center justify-center h-full text-[#64748b]">
                    <div class="text-center">
                        <p class="text-sm">Waiting for logs...</p>
                        <span class="inline-block w-2 h-4 bg-[#64748b] ml-1 animate-blink"></span>
                    </div>
                </div>
            </template>
            <template x-for="(log, i) in filteredLogs" :key="i">
                <div class="flex gap-3 py-0.5 hover:bg-white/[0.02] px-1 rounded">
                    <span class="text-[#64748b] flex-shrink-0 select-none" x-text="formatTime(log.timestamp)"></span>
                    <span class="flex-shrink-0 font-semibold w-16 text-right"
                          :class="{
                              'text-[#94a3b8]': log.level === 'DEBUG',
                              'text-[#5865f2]': log.level === 'INFO',
                              'text-[#f0b232]': log.level === 'WARNING',
                              'text-[#f23f43]': log.level === 'ERROR',
                              'text-[#eb459e]': log.level === 'CRITICAL',
                          }" x-text="log.level"></span>
                    <span class="text-[#e2e8f0] break-all" x-text="log.message"></span>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function logsPage() {
    return {
        logs: [],
        minLevel: 'DEBUG',
        autoScroll: true,
        connected: false,
        maxLogs: 1000,

        levelPriority: { DEBUG: 0, INFO: 1, WARNING: 2, ERROR: 3, CRITICAL: 4 },

        get filteredLogs() {
            const minPriority = this.levelPriority[this.minLevel] || 0;
            return this.logs.filter(l => (this.levelPriority[l.level] || 0) >= minPriority);
        },

        async init() {
            this.connectWs();
        },

        connectWs() {
            window.wsManager.connect('logs', {
                onOpen: () => { this.connected = true; },
                onMessage: (data) => {
                    if (data.type === 'log' && data.data) {
                        this.logs.push(data.data);
                        if (this.logs.length > this.maxLogs) {
                            this.logs = this.logs.slice(-this.maxLogs);
                        }
                        if (this.autoScroll) {
                            this.$nextTick(() => {
                                const container = this.$refs.logContainer;
                                if (container) container.scrollTop = container.scrollHeight;
                            });
                        }
                    }
                },
                onClose: () => { this.connected = false; },
                onError: () => { this.connected = false; }
            });
        },

        reconnect() {
            window.wsManager.close('logs');
            window.wsManager.reconnectAttempts.delete('logs');
            this.connectWs();
        },

        clearLogs() {
            this.logs = [];
        },

        formatTime(ts) {
            if (!ts) return '--:--:--';
            const d = new Date(ts);
            return d.toLocaleTimeString('en-US', { hour12: false });
        },

        destroy() {
            window.wsManager.close('logs');
        }
    };
}
</script>
{% endblock %}

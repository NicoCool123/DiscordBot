{% extends "base.html" %}

{% block title %}Live Logs{% endblock %}
{% block page_title %}Live Logs{% endblock %}

{% block content %}
<div class="space-y-4" x-data="logsPage()">
    <!-- Controls -->
    <div class="card py-4">
        <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center gap-2">
                <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Level:</label>
                <select x-model="minLevel" @change="filterLogs()" class="input w-28 py-1.5 text-sm">
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                    <option value="CRITICAL">CRITICAL</option>
                </select>
            </div>

            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" x-model="autoScroll" class="rounded border-gray-300 dark:border-gray-600 text-discord-blurple focus:ring-discord-blurple bg-white dark:bg-discord-dark">
                <span class="text-sm text-gray-600 dark:text-gray-400">Auto-scroll</span>
            </label>

            <div class="flex-1"></div>

            <div class="flex items-center gap-2 px-2.5 py-1.5 rounded-lg bg-gray-50 dark:bg-discord-dark">
                <span class="w-2 h-2 rounded-full" :class="connected ? 'bg-discord-green' : 'bg-discord-red'"></span>
                <span class="text-xs font-medium" :class="connected ? 'text-discord-green' : 'text-gray-400'" x-text="connected ? 'Connected' : 'Disconnected'"></span>
            </div>

            <span class="text-xs text-gray-400 px-2 py-1 bg-gray-50 dark:bg-discord-dark rounded-lg" x-text="filteredLogs.length + ' entries'"></span>

            <button @click="clearLogs()" class="btn-secondary text-xs py-1.5 px-3">Clear</button>
            <button @click="reconnect()" class="btn-primary text-xs py-1.5 px-3" x-show="!connected" x-cloak>Reconnect</button>
        </div>
    </div>

    <!-- Log Output -->
    <div class="card p-0 overflow-hidden">
        <div
            class="bg-gray-950 dark:bg-[#1a1b1e] p-4 h-[calc(100vh-16rem)] min-h-[300px] overflow-y-auto font-mono text-xs leading-relaxed scrollbar-thin"
            x-ref="logContainer"
        >
            <template x-for="(log, index) in filteredLogs" :key="index">
                <div class="py-0.5 flex gap-2 hover:bg-white/5 px-1 rounded">
                    <span class="text-gray-600 flex-shrink-0 select-none" x-text="formatTimestamp(log.timestamp)"></span>
                    <span
                        class="px-1 py-0 rounded text-[10px] font-bold uppercase flex-shrink-0 leading-5"
                        :class="{
                            'text-gray-500': log.level === 'DEBUG',
                            'text-blue-400': log.level === 'INFO',
                            'text-yellow-400': log.level === 'WARNING',
                            'text-red-400': log.level === 'ERROR',
                            'text-red-300 bg-red-900/30': log.level === 'CRITICAL'
                        }"
                        x-text="log.level.padEnd(8)"
                    ></span>
                    <span class="text-gray-300" x-text="log.message"></span>
                </div>
            </template>

            <div x-show="filteredLogs.length === 0" class="text-center text-gray-600 py-12">
                <svg class="w-8 h-8 mx-auto mb-2 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Waiting for logs...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function logsPage() {
    return {
        logs: [],
        filteredLogs: [],
        minLevel: 'INFO',
        autoScroll: true,
        connected: false,
        levelPriority: { DEBUG: 0, INFO: 1, WARNING: 2, ERROR: 3, CRITICAL: 4 },

        init() {
            this.connect();
        },

        connect() {
            window.wsManager.connect('logs', {
                onOpen: () => {
                    this.connected = true;
                    this.addLog({ level: 'INFO', message: 'Connected to log stream', timestamp: new Date().toISOString() });
                },
                onMessage: (data) => {
                    if (data.type === 'log') {
                        this.addLog(data.data);
                    }
                },
                onClose: () => {
                    this.connected = false;
                    this.addLog({ level: 'WARNING', message: 'Disconnected from log stream', timestamp: new Date().toISOString() });
                },
                onError: () => {
                    this.connected = false;
                }
            });
        },

        reconnect() {
            window.wsManager.close('logs');
            this.connect();
        },

        addLog(log) {
            this.logs.push(log);
            if (this.logs.length > 1000) {
                this.logs.shift();
            }
            this.filterLogs();

            if (this.autoScroll) {
                this.$nextTick(() => {
                    const container = this.$refs.logContainer;
                    if (container) container.scrollTop = container.scrollHeight;
                });
            }
        },

        filterLogs() {
            const minPriority = this.levelPriority[this.minLevel];
            this.filteredLogs = this.logs.filter(log =>
                this.levelPriority[log.level] >= minPriority
            );
        },

        clearLogs() {
            this.logs = [];
            this.filteredLogs = [];
        },

        formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour12: false });
        },

        destroy() {
            window.wsManager.close('logs');
        }
    };
}
</script>
{% endblock %}

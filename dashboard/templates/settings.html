{% extends "base.html" %}

{% block title %}Settings{% endblock %}
{% block page_title %}Bot Settings{% endblock %}

{% block content %}
<div class="max-w-4xl space-y-6" x-data="settingsForm()">
    <!-- Guild Selector -->
    <div class="card">
        <h3 class="text-base font-semibold mb-3">Select Server</h3>
        <div x-show="loadingGuilds" class="text-sm text-gray-400">Loading servers...</div>
        <div x-show="!loadingGuilds && guildsError" x-cloak class="text-sm text-discord-red" x-text="guildsError"></div>
        <div x-show="!loadingGuilds && !guildsError && guilds.length === 0" x-cloak class="text-sm text-gray-400">
            No servers found. <a href="/api/v1/auth/discord" class="text-discord-blurple hover:underline">Login with Discord</a> to manage your servers.
        </div>
        <select x-show="!loadingGuilds && guilds.length > 0" x-cloak x-model="selectedGuild" @change="switchGuild()" class="input max-w-md">
            <option value="">-- Select a server --</option>
            <template x-for="guild in guilds" :key="guild.id">
                <option :value="guild.id" x-text="guild.name + (guild.bot_in_guild ? '' : ' (Bot not added)')"></option>
            </template>
        </select>
    </div>

    <!-- Settings Form -->
    <div class="card" x-show="selectedGuild" x-cloak>
        <h3 class="text-base font-semibold mb-4">Server Settings</h3>

        <form @submit.prevent="saveSettings" class="space-y-6">
            <!-- Basic Settings -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Command Prefix</label>
                    <input type="text" x-model="settings.prefix" class="input" maxlength="5" placeholder="!">
                </div>
                <div>
                    <label class="label">Language</label>
                    <select x-model="settings.language" class="input">
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                        <option value="fr">Francais</option>
                        <option value="es">Espanol</option>
                    </select>
                </div>
            </div>

            <!-- Feature Toggles -->
            <div class="space-y-3">
                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Features</h4>

                <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-discord-dark transition-colors cursor-pointer">
                    <input type="checkbox" x-model="settings.moderation_enabled" class="rounded border-gray-300 dark:border-gray-600 text-discord-blurple focus:ring-discord-blurple bg-white dark:bg-discord-dark">
                    <div>
                        <span class="text-sm font-medium">Moderation</span>
                        <p class="text-xs text-gray-400">Ban, kick, mute and warning commands</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-discord-dark transition-colors cursor-pointer">
                    <input type="checkbox" x-model="settings.logging_enabled" class="rounded border-gray-300 dark:border-gray-600 text-discord-blurple focus:ring-discord-blurple bg-white dark:bg-discord-dark">
                    <div>
                        <span class="text-sm font-medium">Logging</span>
                        <p class="text-xs text-gray-400">Log member joins, leaves, and message edits</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-discord-dark transition-colors cursor-pointer">
                    <input type="checkbox" x-model="settings.welcome_enabled" class="rounded border-gray-300 dark:border-gray-600 text-discord-blurple focus:ring-discord-blurple bg-white dark:bg-discord-dark">
                    <div>
                        <span class="text-sm font-medium">Welcome Messages</span>
                        <p class="text-xs text-gray-400">Greet new members automatically</p>
                    </div>
                </label>
            </div>

            <!-- Channel Settings -->
            <div class="space-y-4">
                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Channels</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="label">Log Channel ID</label>
                        <input type="text" x-model="settings.log_channel_id" class="input" placeholder="Channel ID">
                    </div>
                    <div>
                        <label class="label">Mod Log Channel ID</label>
                        <input type="text" x-model="settings.mod_log_channel_id" class="input" placeholder="Channel ID">
                    </div>
                    <div>
                        <label class="label">Welcome Channel ID</label>
                        <input type="text" x-model="settings.welcome_channel_id" class="input" placeholder="Channel ID">
                    </div>
                </div>
            </div>

            <!-- Welcome Message -->
            <div x-show="settings.welcome_enabled" x-cloak>
                <label class="label">Welcome Message</label>
                <textarea x-model="settings.welcome_message" class="input" rows="3" placeholder="Welcome {user} to {server}!"></textarea>
                <p class="text-xs text-gray-400 mt-1">Use {user} for username, {server} for server name</p>
            </div>

            <!-- Submit -->
            <div class="flex justify-end gap-3 pt-2">
                <button type="button" @click="resetSettings()" class="btn-secondary text-sm">Reset</button>
                <button type="submit" class="btn-primary text-sm" :disabled="saving">
                    <span x-show="!saving">Save Settings</span>
                    <span x-show="saving" x-cloak>Saving...</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Messages -->
    <div x-show="message" x-cloak class="flex items-center gap-2 p-3 rounded-lg" :class="messageType === 'success' ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/50' : 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50'">
        <p class="text-sm" :class="messageType === 'success' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'" x-text="message"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function settingsForm() {
    const defaultSettings = {
        prefix: '!',
        language: 'en',
        moderation_enabled: true,
        logging_enabled: true,
        welcome_enabled: false,
        log_channel_id: '',
        mod_log_channel_id: '',
        welcome_channel_id: '',
        welcome_message: '',
    };

    return {
        guilds: [],
        guildsError: '',
        loadingGuilds: true,
        selectedGuild: '',
        settings: { ...defaultSettings },
        originalSettings: { ...defaultSettings },
        saving: false,
        message: '',
        messageType: '',

        get hasUnsavedChanges() {
            return JSON.stringify(this.settings) !== JSON.stringify(this.originalSettings);
        },

        async init() {
            await this.fetchGuilds();
        },

        async fetchGuilds() {
            this.loadingGuilds = true;
            this.guildsError = '';
            try {
                const res = await Auth.fetch('/api/v1/guilds/');
                if (res.ok) {
                    const data = await res.json();
                    this.guilds = data.guilds || [];
                } else {
                    this.guildsError = 'Failed to load servers. Please try again.';
                }
            } catch (e) {
                this.guildsError = 'Failed to load servers. Please try again.';
            } finally {
                this.loadingGuilds = false;
            }
        },

        switchGuild() {
            if (this.hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Discard them?')) {
                    this.selectedGuild = this._previousGuild || '';
                    return;
                }
            }
            this._previousGuild = this.selectedGuild;
            this.loadSettings();
        },

        async loadSettings() {
            if (!this.selectedGuild) return;

            try {
                const response = await Auth.fetch(`/api/v1/settings/${this.selectedGuild}`);
                if (response.ok) {
                    const data = await response.json();
                    this.settings = { ...defaultSettings, ...data };
                    this.originalSettings = { ...this.settings };
                } else if (response.status === 404) {
                    this.settings = { ...defaultSettings };
                    this.originalSettings = { ...defaultSettings };
                }
            } catch (error) {
                this.showMessage('Failed to load settings', 'error');
            }
        },

        async saveSettings() {
            this.saving = true;
            this.message = '';

            try {
                let response = await Auth.fetch(`/api/v1/settings/${this.selectedGuild}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.settings)
                });

                if (response.status === 404) {
                    response = await Auth.fetch(`/api/v1/settings/${this.selectedGuild}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.settings)
                    });
                }

                if (response.ok) {
                    this.originalSettings = { ...this.settings };
                    this.showMessage('Settings saved successfully', 'success');
                } else {
                    const error = await response.json();
                    this.showMessage(error.detail || 'Failed to save settings', 'error');
                }
            } catch (error) {
                this.showMessage('Failed to save settings', 'error');
            } finally {
                this.saving = false;
            }
        },

        resetSettings() {
            this.settings = { ...this.originalSettings };
        },

        showMessage(text, type) {
            this.message = text;
            this.messageType = type;
            setTimeout(() => { this.message = ''; }, 5000);
        }
    };
}
</script>
{% endblock %}
